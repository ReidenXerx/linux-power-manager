# Intel WiFi Power Management Optimization
# Specifically designed to reduce power spikes on Intel WiFi adapters
# Addresses: AX1775*/AX1790*/BE20*/BE401/BE1750* and similar Intel cards

# ==============================================================================
# KERNEL MODULE PARAMETERS (apply with modprobe.d)
# ==============================================================================

# iwlwifi power saving optimizations
# Reduce power spikes and improve power efficiency
options iwlwifi power_save=1
options iwlwifi power_level=5
options iwlwifi amsdu_size=3           # Smaller AMSDU reduces power spikes
options iwlwifi uapsd_disable=0        # Enable U-APSD for power saving
options iwlwifi bt_coex_active=1       # Better BT/WiFi coexistence

# Disable unnecessary features that cause power spikes
options iwlwifi disable_11ax=0         # Keep WiFi 6 (needed for efficiency)
options iwlwifi disable_11be=0         # Keep WiFi 7 (needed for efficiency)
options iwlwifi led_mode=1             # Reduce LED power consumption

# Advanced power management
options iwlwifi swcrypto=0             # Use hardware crypto (more efficient)
options iwlwifi fw_restart=1           # Allow firmware restart for stability

# ==============================================================================
# RUNTIME OPTIMIZATIONS (apply via scripts)
# ==============================================================================

# WiFi interface power management
# iw dev wlan0 set power_save on

# Advanced Intel-specific power settings
# echo 5 > /sys/module/iwlwifi/parameters/power_level
# echo 1 > /sys/module/iwlwifi/parameters/power_save

# Reduce scan frequency (reduces power spikes)
# iw dev wlan0 scan freq 2412 2437 2462  # Only scan common channels

# ==============================================================================
# NETWORK MANAGER OPTIMIZATIONS
# ==============================================================================

# Disable aggressive scanning
# Add to /etc/NetworkManager/NetworkManager.conf:
# [device]
# wifi.scan-rand-mac-address=no
# wifi.background-scan=no

# Reduce scan interval
# [connection]
# wifi.background-scan-interval=300

# ==============================================================================
# TROUBLESHOOTING POWER SPIKES
# ==============================================================================

# Monitor WiFi power usage:
# sudo powertop (look for wlan0 in device stats)
# watch -n1 'cat /proc/interrupts | grep iwlwifi'
# sudo iotop -o (look for WiFi-related processes)

# Test different power levels (0-5, where 5 is most aggressive):
# echo N > /sys/module/iwlwifi/parameters/power_level

# Check current WiFi power settings:
# iw dev wlan0 get power_save
# cat /sys/module/iwlwifi/parameters/power_save
# cat /sys/module/iwlwifi/parameters/power_level

# ==============================================================================
# PERFORMANCE NOTES
# ==============================================================================

# Power Level Settings:
# 0 = Performance mode (no power saving)
# 1 = Balanced mode (some power saving)
# 2-3 = Moderate power saving
# 4-5 = Aggressive power saving (may affect performance)

# U-APSD (Unscheduled Automatic Power Save Delivery):
# - Reduces power consumption during data transmission
# - Can sometimes cause connectivity issues with older routers
# - Generally safe to enable on modern networks

# Expected power savings:
# - Balanced mode: 1-3W reduction in WiFi power consumption
# - Aggressive mode: 2-5W reduction, but may affect performance
# - Power spike reduction: Up to 50% fewer sudden power draws
